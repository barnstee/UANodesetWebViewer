using Opc.Ua;
using Opc.Ua.Client;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.Threading;
using System.Threading.Tasks;
using System.Web;
using System.Xml;

namespace UANodesetWebViewer
{
    public class OpcSessionCacheData
    {
        public bool Trusted { get; set; }

        public Session OPCSession { get; set; }

        public string CertThumbprint { get; set; }

        public Uri EndpointURL { get; set; }

        public OpcSessionCacheData()
        {
            Trusted = false;
            EndpointURL = new Uri("opc.tcp://localhost:4840");
            CertThumbprint = string.Empty;
            OPCSession = null;
        }
    }

    public class OpcSessionHelper
    {
        public ConcurrentDictionary<string, OpcSessionCacheData> OpcSessionCache = new ConcurrentDictionary<string, OpcSessionCacheData>();

        private static OpcSessionHelper _instance = null;
        private static Object _instanceLock = new Object();

        private static SemaphoreSlim _trustedSessionCertificateValidation = null;

        private static string _trustedSessionId { get; set; } = null;

        internal static string Delimiter { get; } = "__$__";

        public static OpcSessionHelper Instance
        {
            get
            {
                if (_instance == null)
                {
                    lock (_instanceLock)
                    {
                        if (_instance == null)
                        {
                            _instance = new OpcSessionHelper();
                        }
                    }
                }

                return _instance;
            }
        }

        public OpcSessionHelper()
        {
            _trustedSessionCertificateValidation = new SemaphoreSlim(1);
        }

        /// <summary>
        /// Action to disconnect from the currently connected OPC UA server.
        /// </summary>
        public void Disconnect(string sessionID)
        {
            OpcSessionCacheData entry;
            if (OpcSessionCache.TryRemove(sessionID, out entry))
            {
                try
                {
                    if (entry.OPCSession != null)
                    {
                        entry.OPCSession.Close();
                    }
                }
                catch (Exception)
                {
                    // do nothing
                }
            }
        }

        /// <summary>
        /// Ensures session is closed when server does not reply.
        /// </summary>
        private static void StandardClient_KeepAlive(Session sender, KeepAliveEventArgs e)
        {
            if (e != null)
            {
                if (ServiceResult.IsBad(e.Status))
                {
                    e.CancelKeepAlive = true;

                    sender.Close();
                }
            }
        }

        /// <summary>
        /// Checks if there is an active OPC UA session for the provided browser session. If the persisted OPC UA session does not exist,
        /// a new OPC UA session to the given endpoint URL is established.
        /// </summary>
        public async Task<Session> GetSessionAsync(ApplicationConfiguration config, string sessionID, string endpointURL, bool enforceTrust = false)
        {
            if (string.IsNullOrEmpty(sessionID) || string.IsNullOrEmpty(endpointURL))
            {
                return null;
            }

            OpcSessionCacheData entry;
            if (OpcSessionCache.TryGetValue(sessionID, out entry))
            {
                if (entry.OPCSession != null)
                {
                    if (entry.OPCSession.Connected)
                    {
                        return entry.OPCSession;
                    }

                    try
                    {
                        entry.OPCSession.Close(500);
                    }
                    catch (Exception)
                    {
                        // do nothing
                    }

                    entry.OPCSession = null;
                }
            }
            else
            {
                // create a new entry
                OpcSessionCacheData newEntry = new OpcSessionCacheData { EndpointURL = new Uri(endpointURL) };
                OpcSessionCache.TryAdd(sessionID, newEntry);
            }

            Uri endpointURI = new Uri(endpointURL);
            EndpointDescriptionCollection endpointCollection = DiscoverEndpoints(config, endpointURI, 10);
            EndpointDescription selectedEndpoint = SelectUaTcpEndpoint(endpointCollection);
            EndpointConfiguration endpointConfiguration = EndpointConfiguration.Create(config);
            ConfiguredEndpoint endpoint = new ConfiguredEndpoint(null, selectedEndpoint, endpointConfiguration);

            Session session = null;
            try
            {
                // lock the session creation for the enforced trust case
                await _trustedSessionCertificateValidation.WaitAsync();

                if (enforceTrust)
                {
                    // enforce trust in the certificate validator by setting the trusted session id
                    _trustedSessionId = sessionID;
                }

                session = await Session.Create(
                    config,
                    endpoint,
                    true,
                    false,
                    sessionID,
                    60000,
                    new UserIdentity(new AnonymousIdentityToken()),
                    null);

                if (session != null)
                {
                    session.KeepAlive += new KeepAliveEventHandler(StandardClient_KeepAlive);

                    // Update our cache data
                    if (OpcSessionCache.TryGetValue(sessionID, out entry))
                    {
                        if (string.Equals(entry.EndpointURL.AbsoluteUri, endpointURL, StringComparison.InvariantCultureIgnoreCase))
                        {
                            OpcSessionCacheData newValue = new OpcSessionCacheData
                            {
                                CertThumbprint = entry.CertThumbprint,
                                EndpointURL = entry.EndpointURL,
                                Trusted = entry.Trusted,
                                OPCSession = session
                            };
                            OpcSessionCache.TryUpdate(sessionID, newValue, entry);
                        }
                    }
                }
            }
            finally
            {
                _trustedSessionId = null;
                _trustedSessionCertificateValidation.Release();
            }

            return session;
        }

        /// <summary>
        /// Write a given OPC node with the given value.
        /// </summary>
        public (StatusCodeCollection result, DiagnosticInfoCollection diagInfo) WriteOpcNode(string nodeID, string newValue, Session session)
        {
            if (string.IsNullOrEmpty(nodeID) || string.IsNullOrEmpty(newValue) || (session == null))
            {
                return (null, null);
            }

            var node = GetNodeIdFromJsTreeNode(nodeID);

            // Read the variable
            DataValueCollection values = null;
            DiagnosticInfoCollection readDiagnosticInfos = null;
            ReadValueIdCollection nodesToRead = new ReadValueIdCollection();
            foreach (uint attributeId in Attributes.GetIdentifiers())
            {
                ReadValueId valueId = new ReadValueId();
                valueId.NodeId = new NodeId(node);
                valueId.AttributeId = attributeId;
                valueId.IndexRange = null;
                valueId.DataEncoding = null;
                nodesToRead.Add(valueId);
            }

            ResponseHeader responseHeader = session.Read(null, 0, TimestampsToReturn.Neither, nodesToRead,
                out values, out readDiagnosticInfos);

            // get DataType of the node
            Node dataTypeIdNode = null;
            NodeId dataTypeId = null;
            int valueRank = 0;
            for (int ii = 0; ii < nodesToRead.Count; ii++)
            {
                // check if node supports attribute
                if (values[ii].StatusCode == StatusCodes.BadAttributeIdInvalid)
                {
                    continue;
                }

                switch (nodesToRead[ii].AttributeId)
                {
                    case Attributes.DataType:
                        dataTypeId = values[ii].Value as NodeId;
                        if (dataTypeId != null)
                        {
                            dataTypeIdNode = session.ReadNode(dataTypeId);
                        }
                        break;

                    case Attributes.ValueRank:
                        valueRank = (int)values[ii].Value;
                        break;

                    default:
                        break;
                }
            }

            var nodesToWrite = new WriteValueCollection();

            WriteValue writeValue = new WriteValue();
            writeValue.NodeId = new NodeId(node);
            writeValue.AttributeId = Attributes.Value;
            writeValue.IndexRange = null;

            Variant value = new Variant();
            BuildDataValue(ref session, ref value, dataTypeId, valueRank, newValue);
            writeValue.Value.Value = value;
            nodesToWrite.Add(writeValue);

            StatusCodeCollection results;
            DiagnosticInfoCollection writeDiagnosticInfos;
            session.Write(null, nodesToWrite, out results, out writeDiagnosticInfos);

            return (results, writeDiagnosticInfos);
        }

        /// <summary>
        /// Parsing JSTreeNode to read OPC UA Node ID
        /// </summary>
        /// <param name="nodeID"></param>
        /// <returns></returns>
        internal static string GetNodeIdFromJsTreeNode(string nodeID)
        {
            string[] delimiter = { Delimiter };
            string[] nodeIDSplit = nodeID.Split(delimiter, 3, StringSplitOptions.None);

            string node;
            if (nodeIDSplit.Length == 1)
            {
                node = nodeIDSplit[0];
            }
            else
            {
                node = nodeIDSplit[1];
            }
            return node;
        }
        /// <summary>
        /// Builds a variant for the data value.
        /// </summary>
        public void BuildDataValue(ref Session session, ref Variant value, NodeId dataTypeId, int valueRank, string newValue)
        {
            BuiltInType builtinType = Opc.Ua.TypeInfo.GetBuiltInType(dataTypeId, session.TypeTree);
            Type valueType;
            char[] separator = { ',' };
            string[] newValueStrings;
            if (valueRank == ValueRanks.Scalar)
            {
                newValue = newValue.Trim();
                switch (builtinType)
                {
                    case BuiltInType.Byte:
                    case BuiltInType.SByte:
                    case BuiltInType.Int16:
                    case BuiltInType.UInt16:
                    case BuiltInType.Int32:
                    case BuiltInType.UInt32:
                    case BuiltInType.Int64:
                    case BuiltInType.UInt64:
                    case BuiltInType.Float:
                    case BuiltInType.Double:
                        {
                            valueType = Opc.Ua.TypeInfo.GetSystemType(builtinType, valueRank);
                            if (valueType == typeof(SByte))
                            {
                                value = new Variant(Convert.ToSByte(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Byte))
                            {
                                value = new Variant(Convert.ToByte(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Int16))
                            {
                                value = new Variant(Convert.ToInt16(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(UInt16))
                            {
                                value = new Variant(Convert.ToUInt16(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Int32))
                            {
                                value = new Variant(Convert.ToInt32(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(UInt32))
                            {
                                value = new Variant(Convert.ToUInt32(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Int64))
                            {
                                value = new Variant(Convert.ToInt64(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(UInt64))
                            {
                                value = new Variant(Convert.ToUInt64(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Single))
                            {
                                value = new Variant(Convert.ToSingle(newValue, CultureInfo.InvariantCulture));
                            }

                            if (valueType == typeof(Double))
                            {
                                value = new Variant(Convert.ToDouble(newValue, CultureInfo.InvariantCulture));
                            }
                        }
                        break;

                    case BuiltInType.Boolean:
                        {
                            value = Convert.ToBoolean(newValue, CultureInfo.InvariantCulture);
                        }
                        break;

                    case BuiltInType.String:
                        {
                            value = newValue;
                        }
                        break;

                    case BuiltInType.Guid:
                        {
                            value = new Guid(newValue);
                        }
                        break;

                    case BuiltInType.DateTime:
                        {
                            value = new Variant(Convert.ToDateTime(newValue, CultureInfo.InvariantCulture));

                        }
                        break;

                    case BuiltInType.ByteString:
                        {
                            if (newValue.Length % 2 == 1)
                            {
                                Exception e = new Exception("ByteString must have even length.");
                                throw e;
                            }
                            Byte[] byteArray = new Byte[newValue.Length / 2];
                            for (int ii = 0; ii < newValue.Length; ii += 2)
                            {
                                string byteValue = newValue.Substring(ii, 2);
                                byteArray[ii / 2] = Convert.ToByte(byteValue, 16);
                            }
                            value = new Variant(byteArray);
                        }
                        break;

                    case BuiltInType.XmlElement:
                        {
                            string newValueDecoded = HttpUtility.HtmlDecode(newValue);
                            value = (XmlElement)Opc.Ua.TypeInfo.Cast(newValueDecoded, BuiltInType.XmlElement);
                        }
                        break;

                    case BuiltInType.NodeId:
                        {
                            NodeId nodeId = new NodeId(newValue.ToString());
                            value = nodeId;
                        }
                        break;

                    case BuiltInType.ExpandedNodeId:
                        {
                            ExpandedNodeId nodeId = new ExpandedNodeId(newValue.ToString());
                            value = nodeId;
                        }
                        break;

                    case BuiltInType.QualifiedName:
                        {
                            QualifiedName name = new QualifiedName(newValue.ToString());
                            value = name;
                        }
                        break;

                    case BuiltInType.LocalizedText:
                        {
                            LocalizedText text = new LocalizedText(newValue.ToString());
                            value = text;
                        }
                        break;

                    case BuiltInType.StatusCode:
                        {
                            StatusCode status = new StatusCode(Convert.ToUInt32(newValue, 16));
                            value = status;
                        }
                        break;

                    case BuiltInType.Variant:
                        {
                            value = (Variant)Opc.Ua.TypeInfo.Cast(newValue, BuiltInType.Variant);
                        }
                        break;

                    case BuiltInType.Enumeration:
                        {
                            value = new Variant(Opc.Ua.TypeInfo.Cast(newValue, BuiltInType.Enumeration));
                        }
                        break;

                    case BuiltInType.ExtensionObject:
                        {
                            value = new ExtensionObject(newValue);
                        }
                        break;

                    case BuiltInType.Number:
                    case BuiltInType.Integer:
                    case BuiltInType.UInteger:
                        {
                            value = new Variant(Opc.Ua.TypeInfo.Cast(newValue, builtinType));
                        }
                        break;
                }
            }
            else if (valueRank == ValueRanks.OneDimension)
            {
                switch (builtinType)
                {
                    case BuiltInType.Byte:
                    case BuiltInType.SByte:
                    case BuiltInType.Int16:
                    case BuiltInType.UInt16:
                    case BuiltInType.Int32:
                    case BuiltInType.UInt32:
                    case BuiltInType.Int64:
                    case BuiltInType.UInt64:
                    case BuiltInType.Float:
                    case BuiltInType.Double:
                        {
                            valueType = Opc.Ua.TypeInfo.GetSystemType(builtinType, valueRank);
                            if (valueType == typeof(SByte[]))
                            {
                                List<SByte> valList = new List<SByte>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToSByte(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Byte[]))
                            {
                                List<Byte> valList = new List<Byte>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToByte(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Int16[]))
                            {
                                List<Int16> valList = new List<Int16>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToInt16(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(UInt16[]))
                            {
                                List<UInt16> valList = new List<UInt16>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToUInt16(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Int32[]))
                            {
                                List<Int32> valList = new List<Int32>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToInt32(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(UInt32[]))
                            {
                                List<UInt32> valList = new List<UInt32>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToUInt32(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Int64[]))
                            {
                                List<Int64> valList = new List<Int64>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToInt64(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(UInt64[]))
                            {
                                List<UInt64> valList = new List<UInt64>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToUInt64(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Single[]))
                            {
                                List<Single> valList = new List<Single>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToSingle(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                            if (valueType == typeof(Double[]))
                            {
                                List<Double> valList = new List<Double>();
                                newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                                for (int i = 0; i < newValueStrings.Length; i++)
                                {
                                    valList.Add(Convert.ToDouble(newValueStrings[i], CultureInfo.InvariantCulture));
                                }
                                value = new Variant(valList);
                            }

                        }
                        break;

                    case BuiltInType.Boolean:
                        {
                            List<Boolean> valList = new List<Boolean>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add(Convert.ToBoolean(newValueStrings[i], CultureInfo.InvariantCulture));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.String:
                        {
                            List<String> valList = new List<String>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add(Convert.ToString(newValueStrings[i], CultureInfo.InvariantCulture));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.Guid:
                        {
                            List<Guid> valList = new List<Guid>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add(new Guid(newValueStrings[i]));
                            }
                            Guid[] valArray = valList.ToArray();
                            value = new Variant(valArray);
                        }
                        break;

                    case BuiltInType.DateTime:
                        {
                            List<DateTime> valList = new List<DateTime>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add(Convert.ToDateTime(newValueStrings[i], CultureInfo.InvariantCulture));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.ByteString:
                        {
                            List<Byte[]> valList = new List<Byte[]>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                if (newValueStrings[i].Length % 2 == 1)
                                {
                                    Exception e = new Exception("ByteString must have even length.");
                                    throw e;
                                }
                                Byte[] byteArray = new Byte[newValueStrings[i].Length / 2];
                                for (int ii = 0; ii < newValueStrings[i].Length; ii += 2)
                                {
                                    string byteValue = newValueStrings[i].Substring(ii, 2);
                                    byteArray[ii / 2] = Convert.ToByte(byteValue, 16);
                                }
                                valList.Add(byteArray);
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.XmlElement:
                        {
                            List<XmlElement> valList = new List<XmlElement>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                string newValueDecoded = HttpUtility.HtmlDecode(newValueStrings[i]);
                                valList.Add((XmlElement)Opc.Ua.TypeInfo.Cast(newValueDecoded, BuiltInType.XmlElement));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.NodeId:
                        {
                            List<NodeId> valList = new List<NodeId>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add((NodeId)Opc.Ua.TypeInfo.Cast(newValueStrings[i], BuiltInType.NodeId));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.ExpandedNodeId:
                        {
                            List<ExpandedNodeId> valList = new List<ExpandedNodeId>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add((ExpandedNodeId)Opc.Ua.TypeInfo.Cast(newValueStrings[i], BuiltInType.ExpandedNodeId));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.QualifiedName:
                        {
                            List<QualifiedName> valList = new List<QualifiedName>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add(new QualifiedName(newValueStrings[i]));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.LocalizedText:
                        {
                            List<LocalizedText> valList = new List<LocalizedText>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add(new LocalizedText(newValueStrings[i]));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.StatusCode:
                        {
                            List<StatusCode> valList = new List<StatusCode>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                valList.Add(new StatusCode(Convert.ToUInt32(newValueStrings[i], 16)));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.Variant:
                        {
                            List<Variant> valList = new List<Variant>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add((Variant)Opc.Ua.TypeInfo.Cast(newValueStrings[i], BuiltInType.Variant));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.Enumeration:
                        {
                            List<Enumeration> valList = new List<Enumeration>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add((Enumeration)Opc.Ua.TypeInfo.Cast(newValueStrings[i], BuiltInType.Enumeration));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.ExtensionObject:
                        {
                            List<ExtensionObject> valList = new List<ExtensionObject>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                valList.Add((ExtensionObject)new ExtensionObject(newValueStrings[i]));
                            }
                            value = new Variant(valList);
                        }
                        break;

                    case BuiltInType.Number:
                    case BuiltInType.Integer:
                    case BuiltInType.UInteger:
                        {
                            List<Variant> valList = new List<Variant>();
                            newValueStrings = newValue.Split(separator, StringSplitOptions.RemoveEmptyEntries);
                            for (int i = 0; i < newValueStrings.Length; i++)
                            {
                                newValueStrings[i] = newValueStrings[i].Trim();
                                Variant v = new Variant(Opc.Ua.TypeInfo.Cast(newValueStrings[i], builtinType));
                                valList.Add(v);
                            }
                            value = new Variant(valList);
                        }
                        break;
                }
            }
            else
            {
                Exception e = new Exception("Value rank " + valueRank.ToString(CultureInfo.CurrentCulture) + " is not supported");
                throw e;
            }
        }

        /// <summary>
        /// Uses a discovery client to discover the endpoint description of a given server
        /// </summary>
        private EndpointDescriptionCollection DiscoverEndpoints(ApplicationConfiguration config, Uri discoveryUrl, int timeout)
        {
            EndpointConfiguration configuration = EndpointConfiguration.Create(config);
            configuration.OperationTimeout = timeout;

            using (DiscoveryClient client = DiscoveryClient.Create(
                discoveryUrl,
                EndpointConfiguration.Create(config)))
            {
                try
                {
                    EndpointDescriptionCollection endpoints = client.GetEndpoints(null);
                    return ReplaceLocalHostWithRemoteHost(endpoints, discoveryUrl);
                }
                catch (Exception e)
                {
                    Trace.TraceError("Can not fetch endpoints from url: {0}", discoveryUrl);
                    Trace.TraceError("Reason = {0}", e.Message);
                    throw;
                }
            }
        }

        /// <summary>
        /// Selects the UA TCP endpoint with the highest security level
        /// </summary>
        private EndpointDescription SelectUaTcpEndpoint(EndpointDescriptionCollection endpointCollection)
        {
            EndpointDescription bestEndpoint = null;
            foreach (EndpointDescription endpoint in endpointCollection)
            {
                if (endpoint.TransportProfileUri == Profiles.UaTcpTransport)
                {
                    if ((bestEndpoint == null) ||
                        (endpoint.SecurityLevel > bestEndpoint.SecurityLevel))
                    {
                        bestEndpoint = endpoint;
                    }
                }
            }

            return bestEndpoint;
        }

        /// <summary>
        /// Replaces all instances of "LocalHost" in a collection of endpoint description with the real host name
        /// </summary>
        private EndpointDescriptionCollection ReplaceLocalHostWithRemoteHost(EndpointDescriptionCollection endpoints, Uri discoveryUrl)
        {
            EndpointDescriptionCollection updatedEndpoints = endpoints;

            foreach (EndpointDescription endpoint in updatedEndpoints)
            {
                endpoint.EndpointUrl = Utils.ReplaceLocalhost(endpoint.EndpointUrl, discoveryUrl.DnsSafeHost);

                StringCollection updatedDiscoveryUrls = new StringCollection();
                foreach (string url in endpoint.Server.DiscoveryUrls)
                {
                    updatedDiscoveryUrls.Add(Utils.ReplaceLocalhost(url, discoveryUrl.DnsSafeHost));
                }

                endpoint.Server.DiscoveryUrls = updatedDiscoveryUrls;
            }

            return updatedEndpoints;
        }
    }
}